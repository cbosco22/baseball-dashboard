import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go

st.set_page_config(page_title="College Baseball Recruiting Map", layout="wide")
st.title("College Baseball Player Origins Dashboard")

# ====================== LOAD DATA ======================
@st.cache_data(show_spinner=False)
def load_data():
    pitchers = pd.read_csv('pitchers.csv')
    hitters = pd.read_csv('hitters.csv')
    pitchers['role'] = 'Pitcher'
    hitters['role'] = 'Hitter'
    df = pd.concat([pitchers, hitters], ignore_index=True)

    # Clean & split hsplace into City + State
    df[['city', 'state_full']] = df['hsplace'].str.split(',', n=1, expand=True)
    df['state_full'] = df['state_full'].str.strip()
    df['city'] = df['city'].str.strip().str.title()

    # Manual state abbreviation mapping (only the ones we need)
    state_map = {'California': 'CA', 'Texas': 'TX', 'Florida': 'FL', 'Georgia': 'GA', 'New York': 'NY', 
                 'North Carolina': 'NC', 'Illinois': 'IL', 'Pennsylvania': 'PA', 'Ohio': 'OH', 'Michigan': 'MI',
                 'Virginia': 'VA', 'Tennessee': 'TN', 'New Jersey': 'NJ', 'South Carolina': 'SC', 'Alabama': 'AL',
                 'Louisiana': 'LA', 'Missouri': 'MO', 'Arizona': 'AZ', 'Colorado': 'CO', 'Oregon': 'OR', 
                 'Nevada': 'NV', 'Washington': 'WA', 'Massachusetts': 'MA', 'Maryland': 'MD', 'Kentucky': 'KY',
                 'Oklahoma': 'OK', 'Arkansas': 'AR', 'Indiana': 'IN', 'Mississippi': 'MS', 'Wisconsin': 'WI',
                 'Minnesota': 'MN', 'Iowa': 'IA', 'Kansas': 'KS', 'Nebraska': 'NE', 'Idaho': 'ID', 'Utah': 'UT',
                 'New Mexico': 'NM', 'West Virginia': 'WV', 'Hawaii': 'HI', 'Alaska': 'AK', 'Connecticut': 'CT',
                 'Rhode Island': 'RI', 'Maine': 'ME', 'New Hampshire': 'NH', 'Vermont': 'VT', 'Delaware': 'DE',
                 'South Dakota': 'SD', 'North Dakota': 'ND', 'Montana': 'MT', 'Wyoming': 'WY', 'District of Columbia': 'DC'}

    df['state'] = df['state_full'].map(state_map).fillna(df['state_full'])

    return df

df = load_data()

# ====================== SIDEBAR FILTERS ======================
st.sidebar.header("Filters")

# Independent filters (you no longer need to pick league before school)
league_options = ['All'] + sorted(df['LeagueAbbr'].dropna().unique().tolist())
team_options   = ['All'] + sorted(df['teamName'].dropna().unique().tolist())

selected_league = st.sidebar.multiselect("League", options=league_options, default=['All'])
selected_team   = st.sidebar.multiselect("School / Team", options=team_options, default=['All'])
selected_role   = st.sidebar.multiselect("Role", options=['Pitcher', 'Hitter'], default=['Pitcher', 'Hitter'])

year_range = st.sidebar.slider("Year Range", int(df['year'].min()), int(df['year'].max()),
                               (int(df['year'].min()), int(df['year'].max())))

# New filters you asked for
drafted = st.sidebar.checkbox("Only Drafted Players", value=False)
if drafted:
    round_range = st.sidebar.slider("Draft Round", 1, 50, (1, 20))

games_min = st.sidebar.slider("Minimum Games Played", 0, 200, 0)

# ====================== APPLY FILTERS ======================
filtered = df.copy()

if 'All' not in selected_league:
    filtered = filtered[filtered['LeagueAbbr'].isin(selected_league)]
if 'All' not in selected_team:
    filtered = filtered[filtered['teamName'].isin(selected_team)]
if selected_role:
    filtered = filtered[filtered['role'].isin(selected_role)]

filtered = filtered[filtered['year'].between(year_range[0], year_range[1])]

if drafted:
    filtered = filtered[filtered['draft_year'].notna()]
    filtered = filtered[(filtered['draft_Round'] >= round_range[0]) & (filtered['draft_Round'] <= round_range[1])]

if 'G' in filtered.columns:
    filtered = filtered[filtered['G'].fillna(0) >= games_min]

# ====================== DYNAMIC PINPOINT MAP ======================
st.subheader(f"Player High School Locations  •  {len(filtered):,} players")

# Use Plotly Scatter Mapbox — this is what gives the exact look you loved
fig = px.scatter_mapbox(filtered,
                        lat=None, lon=None,
                        hover_name="firstname" + " " + filtered["lastname"],
                        hover_data={"teamName": True, "year": True, "hsplace": True, "role": True},
                        zoom=3,
                        height=700,
                        color="role",
                        color_discrete_map={"Pitcher": "#00D4FF", "Hitter": "#FF6B6B"},
                        title=None)

fig.update_layout(
    mapbox_style="carto-darkmatter",   # ← exact dark style you had
    mapbox_accesstoken="pk.eyJ1IjoiY2hyaXNib3NjbzIyIiwiYSI6ImNseGV3N2ZoeDAwdnYyanB2Z3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F3N3F filtered.empty:
    st.write("No data matches filters.")
else:
    st.plotly_chart(fig, use_container_width=True)

# ====================== FILTERED PLAYERS TABLE ======================
st.subheader(f"Filtered Players ({len(filtered)})")
col1, col2 = st.columns([3,1])
with col1:
    # Let user choose columns
    all_cols = df.columns.tolist()
    default_cols = ['firstname', 'lastname', 'year', 'teamName', 'LeagueAbbr', 'hsplace', 'state', 'role', 'Age', 'ht', 'WT', 'draft_year', 'draft_Round', 'G', 'ERA', 'OPS']
    selected_cols = st.multiselect("Choose columns to display", options=all_cols, default=[c for c  c in default_cols if c in all_cols])
    if selected_cols:
        st.dataframe(filtered[selected_cols].reset_index(drop=True), height=600, use_container_width=True)
    else:
        st.dataframe(filtered.reset_index(drop=True), height=600, use_container_width=True)

# ====================== BONUS: REGION FILTER & CHARTS ======================
regions = {
    "New England": ["CT", "MA", "ME", "NH", "RI", "VT"],
    "Mid Atlantic": ["NJ", "NY", "PA"],
    "South': ["AL", "AR", "FL", "GA", "KY", "LA", "MS", "NC", "SC", "TN", "VA", "WV"],
    "Midwest I": ["IL", "IN", "MI", "OH", "WI"],
    "Midwest II": ["IA", "KS", "MO", "NE", "ND", "SD", "MN"],
    "Southwest": ["AZ", "NM", "OK", "TX"],
    "West": [" AK", "CA", "CO", "HI", "ID", "MT", "NV", "OR", "UT", "WA", "WY"],
    "International": []  # can be filled later
}

region_list = list(regions.keys())
selected_region = st.sidebar.multiselect("Region", ["All"] + region_list, default=["All"])

if "All" not in selected_region:
    states_in_region = [s for r in selected_region for s in regions[r]]
    filtered = filtered[filtered['state'].isin(states_in_region)]

# Region Pie chart
col_a, col_b = st.columns(2)
with col_a:
    st.subheader("Players by Region")
    region_counts = filtered.copy()
    for r, sts in regions.items():
        region_counts.loc[region_counts['state'].isin(sts), 'region'] = r
    rc = region_counts['region'].value_counts()
    fig_pie = px.pie(names=rc.index, values=rc.values, hole=0.4, color_discrete_sequence=px.colors.qualitative.Vivid)
    st.plotly_chart(fig_pie, use_container_width=True)

with col_b:
    st.subheader("Top 15 Recruiting States")
    state_order = filtered['state'].value_counts().head(15)
    fig_bar = px.bar(x=state_order.values, y=state_order.index, orientation='h', color=state_order.values, color_continuous_scale='Viridis')
    fig_bar.update_layout(height=500, yaxis={'categoryorder':'total ascending'})
    st.plotly_chart(fig_bar, use_container_width=True)

st.success("Pinpoint map + independent filters + draft filters + games played filter + customizable columns + regions are all live!")

### What to do now:
